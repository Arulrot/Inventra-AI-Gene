<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Suppliers | Inventor AI Genie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
    }
    
    .ai-header {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px);
      padding: 1.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .main-container {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      margin: 2rem;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      min-height: 80vh;
    }
    
    .supplier-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
      position: relative;
    }
    
    .supplier-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      border-color: #28a745;
    }
    
    .supplier-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(45deg, #28a745, #20c997);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .stats-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid #f1f3f4;
    }
    
    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .search-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid #e9ecef;
    }
    
    .btn-add {
      background: linear-gradient(45deg, #28a745, #20c997);
      border: none;
      color: white;
      font-weight: 600;
      padding: 12px 25px;
      border-radius: 25px;
      transition: all 0.3s ease;
    }
    
    .btn-add:hover {
      transform: translateY(-2px);
      color: white;
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="ai-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1 class="text-white mb-0">
            <i class="bi bi-truck me-2"></i>Supplier Management
          </h1>
          <p class="text-white-50 mb-0">Manage your supplier network efficiently</p>
        </div>
        <div class="col-md-6 text-end">
          <a href="dashboard.html" class="btn btn-outline-light me-2">
            <i class="bi bi-arrow-left me-2"></i>Dashboard
          </a>
          <button class="btn btn-add" onclick="showAddModal()">
            <i class="bi bi-plus me-2"></i>Add Supplier
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Statistics Overview -->
    <div class="row g-4 mb-4">
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <i class="bi bi-truck display-4 text-success mb-3"></i>
          <h3 class="mb-1" id="totalSuppliers">0</h3>
          <p class="text-muted mb-0">Total Suppliers</p>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <i class="bi bi-check-circle display-4 text-primary mb-3"></i>
          <h3 class="mb-1" id="activeSuppliers">0</h3>
          <p class="text-muted mb-0">Active Suppliers</p>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <i class="bi bi-box-seam display-4 text-info mb-3"></i>
          <h3 class="mb-1" id="totalProducts">0</h3>
          <p class="text-muted mb-0">Products Supplied</p>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="stats-card">
          <i class="bi bi-calendar-check display-4 text-warning mb-3"></i>
          <h3 class="mb-1" id="recentOrders">0</h3>
          <p class="text-muted mb-0">Recent Orders</p>
        </div>
      </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
      <div class="row g-3 align-items-center">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Search suppliers by name, ID, or contact...">
          </div>
        </div>
        <div class="col-md-4">
          <button class="btn btn-outline-primary w-100" onclick="refreshSuppliers()">
            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Suppliers Grid -->
    <div class="row g-4" id="suppliersGrid">
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3">Loading suppliers...</div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5" style="display: none;">
      <i class="bi bi-truck display-1 text-muted mb-3"></i>
      <h4 class="text-muted">No suppliers found</h4>
      <p class="text-muted mb-4">Start building your supplier network by adding your first supplier</p>
      <button class="btn btn-add btn-lg" onclick="showAddModal()">
        <i class="bi bi-plus-circle me-2"></i>Add First Supplier
      </button>
    </div>
  </div>

  <!-- Add/Edit Supplier Modal -->
  <div class="modal fade" id="supplierModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalTitle">
            <i class="bi bi-plus-circle me-2"></i>Add New Supplier
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="supplierForm">
          <div class="modal-body">
            <input type="hidden" id="supplierId">
            
            <!-- Essential Information Only -->
            <div class="row g-3">
              <div class="col-md-6">
                <label for="supplierIdField" class="form-label">Supplier ID *</label>
                <input type="text" class="form-control" id="supplierIdField" required>
              </div>
              <div class="col-md-6">
                <label for="supplierName" class="form-label">Supplier Name *</label>
                <input type="text" class="form-control" id="supplierName" required>
              </div>
              <div class="col-md-6">
                <label for="supplierPhone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="supplierPhone">
              </div>
              <div class="col-md-6">
                <label for="supplierEmail" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="supplierEmail">
              </div>
              <div class="col-12">
                <label for="supplierAddress" class="form-label">Address</label>
                <textarea class="form-control" id="supplierAddress" rows="2" placeholder="Business address..."></textarea>
              </div>
            </div>

            <div id="errorAlert" class="alert alert-danger mt-3" style="display: none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success" id="saveBtn">
              <i class="bi bi-check-circle me-2"></i>Save Supplier
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle me-2"></i>Delete Supplier
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete "<strong id="deleteSupplierName"></strong>"?</p>
          <div class="alert alert-warning">
            <i class="bi bi-warning me-2"></i>This action cannot be undone.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="bi bi-trash me-2"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables
    let suppliers = [];
    let filteredSuppliers = [];
    let editingId = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadSuppliers();
      setupEventListeners();
      generateSupplierID();
    });

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('supplierForm').addEventListener('submit', handleFormSubmit);
      document.getElementById('confirmDeleteBtn').addEventListener('click', handleDelete);
      document.getElementById('searchInput').addEventListener('input', filterSuppliers);
    }

    // Generate unique supplier ID
    function generateSupplierID() {
      const timestamp = Date.now().toString().slice(-6);
      document.getElementById('supplierIdField').value = 'SUP' + timestamp;
    }

    // Load suppliers from API
    async function loadSuppliers() {
      try {
        showLoading(true);
        const response = await fetch('/api/suppliers');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        suppliers = await response.json();
        filteredSuppliers = [...suppliers];
        
        displaySuppliers();
        updateStats();
        
      } catch (error) {
        console.error('Error loading suppliers:', error);
        showToast('Failed to load suppliers. Please try again.', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Display suppliers in clean cards
    function displaySuppliers() {
      const grid = document.getElementById('suppliersGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (filteredSuppliers.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      const html = filteredSuppliers.map(supplier => `
        <div class="col-lg-4 col-md-6">
          <div class="supplier-card">
            <div class="d-flex align-items-center mb-3">
              <div class="supplier-avatar me-3">
                ${supplier.name.charAt(0).toUpperCase()}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0 fw-bold">${escapeHtml(supplier.name)}</h6>
                <small class="text-muted">ID: ${supplier.supplier_id || supplier.id}</small>
              </div>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="#" onclick="editSupplier(${supplier.id})">
                      <i class="bi bi-pencil me-2"></i>Edit
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="confirmDelete(${supplier.id}, '${escapeHtml(supplier.name)}')">
                      <i class="bi bi-trash me-2"></i>Delete
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            
            <!-- Contact Information -->
            <div class="mb-3">
              ${supplier.phone ? `
                <div class="mb-2">
                  <i class="bi bi-telephone text-success me-2"></i>
                  <span class="small">${supplier.phone}</span>
                </div>
              ` : ''}
              
              ${supplier.email ? `
                <div class="mb-2">
                  <i class="bi bi-envelope text-primary me-2"></i>
                  <span class="small">${supplier.email}</span>
                </div>
              ` : ''}
              
              ${supplier.address ? `
                <div class="mb-2">
                  <i class="bi bi-geo-alt text-info me-2"></i>
                  <span class="small">${supplier.address}</span>
                </div>
              ` : ''}
            </div>
            
            <!-- Quick Stats -->
            <div class="row text-center pt-3 border-top">
              <div class="col-6">
                <div class="fw-bold text-primary">0</div>
                <small class="text-muted">Products</small>
              </div>
              <div class="col-6">
                <div class="fw-bold text-success">Active</div>
                <small class="text-muted">Status</small>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      grid.innerHTML = html;
    }

    // Update statistics
    function updateStats() {
      document.getElementById('totalSuppliers').textContent = suppliers.length;
      document.getElementById('activeSuppliers').textContent = suppliers.length;
    }

    // Filter suppliers
    function filterSuppliers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      filteredSuppliers = suppliers.filter(supplier => {
        return !searchTerm || 
          supplier.name.toLowerCase().includes(searchTerm) ||
          (supplier.supplier_id && supplier.supplier_id.toLowerCase().includes(searchTerm)) ||
          (supplier.email && supplier.email.toLowerCase().includes(searchTerm)) ||
          (supplier.phone && supplier.phone.includes(searchTerm));
      });
      
      displaySuppliers();
    }

    // Show add modal
    function showAddModal() {
      editingId = null;
      document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add New Supplier';
      document.getElementById('supplierForm').reset();
      document.getElementById('supplierId').value = '';
      generateSupplierID();
      document.getElementById('saveBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Save Supplier';
      hideError();
      
      new bootstrap.Modal(document.getElementById('supplierModal')).show();
    }

    // Edit supplier
    async function editSupplier(id) {
      try {
        const response = await fetch(`/api/suppliers/${id}`);
        if (!response.ok) throw new Error('Supplier not found');
        
        const supplier = await response.json();
        editingId = id;
        
        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Supplier';
        document.getElementById('supplierId').value = supplier.id;
        document.getElementById('supplierIdField').value = supplier.supplier_id || supplier.id;
        document.getElementById('supplierName').value = supplier.name;
        document.getElementById('supplierPhone').value = supplier.phone || '';
        document.getElementById('supplierEmail').value = supplier.email || '';
        document.getElementById('supplierAddress').value = supplier.address || '';
        document.getElementById('saveBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Update Supplier';
        hideError();
        
        new bootstrap.Modal(document.getElementById('supplierModal')).show();
        
      } catch (error) {
        console.error('Error loading supplier:', error);
        showToast('Error loading supplier details', 'error');
      }
    }

    // Handle form submission
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('saveBtn');
      const originalHTML = submitBtn.innerHTML;
      
      try {
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        submitBtn.disabled = true;
        
        const formData = {
          supplier_id: document.getElementById('supplierIdField').value,
          name: document.getElementById('supplierName').value,
          phone: document.getElementById('supplierPhone').value,
          email: document.getElementById('supplierEmail').value,
          address: document.getElementById('supplierAddress').value
        };
        
        // Basic validation
        if (!formData.name.trim()) {
          showError('Supplier name is required');
          return;
        }
        
        if (!formData.supplier_id.trim()) {
          showError('Supplier ID is required');
          return;
        }
        
        const url = editingId ? `/api/suppliers/${editingId}` : '/api/suppliers';
        const method = editingId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide();
        await loadSuppliers();
        showToast(editingId ? 'Supplier updated successfully!' : 'Supplier added successfully!', 'success');
        
      } catch (error) {
        console.error('Error saving supplier:', error);
        showError('Failed to save supplier. Please try again.');
      } finally {
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;
      }
    }

    // Confirm delete
    function confirmDelete(id, name) {
      document.getElementById('deleteSupplierName').textContent = name;
      document.getElementById('confirmDeleteBtn').setAttribute('data-id', id);
      new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    // Handle delete
    async function handleDelete() {
      const id = document.getElementById('confirmDeleteBtn').getAttribute('data-id');
      
      try {
        const response = await fetch(`/api/suppliers/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete supplier');
        
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
        await loadSuppliers();
        showToast('Supplier deleted successfully!', 'success');
        
      } catch (error) {
        console.error('Error deleting supplier:', error);
        showToast('Failed to delete supplier', 'error');
      }
    }

    // Refresh suppliers
    async function refreshSuppliers() {
      await loadSuppliers();
      showToast('Data refreshed successfully', 'success');
    }

    // Utility functions
    function showLoading(show) {
      const grid = document.getElementById('suppliersGrid');
      if (show) {
        grid.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-3">Loading suppliers...</div>
          </div>
        `;
      }
    }

    function showError(message) {
      const alert = document.getElementById('errorAlert');
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => alert.style.display = 'none', 5000);
    }

    function hideError() {
      document.getElementById('errorAlert').style.display = 'none';
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
      
      const toastHTML = `
        <div class="toast align-items-center text-white ${bgClass} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">
              <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toastElement = toastContainer.lastElementChild;
      const toast = new bootstrap.Toast(toastElement);
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
