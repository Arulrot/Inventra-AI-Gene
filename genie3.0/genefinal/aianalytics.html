<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Analytics | Inventor AI Genie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap 5 & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
    }
    
    .ai-header {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px);
      padding: 1rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .main-container {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      margin: 2rem;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    .analytics-card {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      border-left: 5px solid #667eea;
    }
    
    .priority-chip {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .priority-5 { background: #ff4757; color: white; }
    .priority-4 { background: #ff6b4a; color: white; }
    .priority-3 { background: #ffa726; color: white; }
    .priority-2 { background: #26a69a; color: white; }
    .priority-1 { background: #78909c; color: white; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="ai-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1 class="text-white mb-0">
            <i class="bi bi-graph-up me-2"></i>AI Analytics Dashboard
          </h1>
        </div>
        <div class="col-md-6 text-end">
          <a href="dashboard.html" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-container">
    <!-- AI Insights Summary -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="analytics-card">
          <h3 class="mb-4">
            <i class="bi bi-cpu me-2"></i>AI Intelligence Summary
          </h3>
          <div class="row g-4">
            <div class="col-md-3">
              <div class="text-center">
                <div class="display-4 text-danger" id="criticalAlerts">0</div>
                <small class="text-muted">Critical Alerts</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <div class="display-4 text-warning" id="warningAlerts">0</div>
                <small class="text-muted">Warnings</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <div class="display-4 text-info" id="infoAlerts">0</div>
                <small class="text-muted">Recommendations</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <div class="display-4 text-success" id="completedActions">0</div>
                <small class="text-muted">Actions Taken</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="analytics-card">
          <h5 class="mb-3">
            <i class="bi bi-pie-chart me-2"></i>Recommendation Types
          </h5>
          <canvas id="recommendationChart" width="400" height="300"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="analytics-card">
          <h5 class="mb-3">
            <i class="bi bi-bar-chart me-2"></i>Priority Distribution
          </h5>
          <canvas id="priorityChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed Recommendations -->
    <div class="analytics-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>
          <i class="bi bi-list-check me-2"></i>Detailed AI Recommendations
        </h4>
        <button class="btn btn-primary" onclick="refreshAnalytics()">
          <i class="bi bi-arrow-clockwise me-2"></i>Refresh Analytics
        </button>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>Priority</th>
              <th>Type</th>
              <th>Product</th>
              <th>Recommendation</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="recommendationsTable">
            <tr>
              <td colspan="6" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-2">Loading AI recommendations...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let recommendationChart, priorityChart;
    
    document.addEventListener('DOMContentLoaded', function() {
      loadAnalytics();
      initializeCharts();
    });

    async function loadAnalytics() {
      try {
        const response = await fetch('/api/ai/recommendations');
        if (!response.ok) throw new Error('Failed to load analytics');
        
        const recommendations = await response.json();
        
        displaySummary(recommendations);
        displayRecommendationsTable(recommendations);
        updateCharts(recommendations);
        
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function displaySummary(recommendations) {
      const critical = recommendations.filter(r => r.priority >= 4).length;
      const warning = recommendations.filter(r => r.priority === 3).length;
      const info = recommendations.filter(r => r.priority <= 2).length;
      
      document.getElementById('criticalAlerts').textContent = critical;
      document.getElementById('warningAlerts').textContent = warning;
      document.getElementById('infoAlerts').textContent = info;
    }

    function displayRecommendationsTable(recommendations) {
      const tbody = document.getElementById('recommendationsTable');
      
      if (recommendations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <i class="bi bi-check-circle display-1 text-success"></i>
              <div class="mt-3">No recommendations at this time. Everything looks good!</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = recommendations.map(rec => `
        <tr>
          <td>
            <span class="priority-chip priority-${rec.priority}">
              ${rec.priority}/5
            </span>
          </td>
          <td>
            <span class="badge bg-secondary">${rec.type.replace('_', ' ')}</span>
          </td>
          <td>
            <strong>${rec.product_name || 'System'}</strong>
            ${rec.current_stock !== null ? `<br><small class="text-muted">Stock: ${rec.current_stock}</small>` : ''}
          </td>
          <td>
            ${rec.message}
          </td>
          <td>
            <small class="text-muted">
              ${new Date(rec.created_date).toLocaleDateString()}
            </small>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewProduct(${rec.product_id})">
              <i class="bi bi-eye"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function initializeCharts() {
      // Recommendation Types Chart
      const ctx1 = document.getElementById('recommendationChart').getContext('2d');
      recommendationChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['Low Stock', 'Non-Movable', 'Expiry Warning', 'Reorder'],
          datasets: [{
            data: [0, 0, 0, 0],
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Priority Chart
      const ctx2 = document.getElementById('priorityChart').getContext('2d');
      priorityChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: ['Priority 1', 'Priority 2', 'Priority 3', 'Priority 4', 'Priority 5'],
          datasets: [{
            label: 'Recommendations',
            data: [0, 0, 0, 0, 0],
            backgroundColor: ['#78909c', '#26a69a', '#ffa726', '#ff6b4a', '#ff4757']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function updateCharts(recommendations) {
      // Update recommendation types chart
      const types = {
        'LOW_STOCK': 0,
        'NON_MOVABLE': 0,
        'EXPIRY_WARNING': 0,
        'REORDER_SUGGESTION': 0
      };
      
      recommendations.forEach(rec => {
        if (types.hasOwnProperty(rec.type)) {
          types[rec.type]++;
        }
      });
      
      recommendationChart.data.datasets[0].data = [
        types.LOW_STOCK,
        types.NON_MOVABLE,
        types.EXPIRY_WARNING,
        types.REORDER_SUGGESTION
      ];
      recommendationChart.update();

      // Update priority chart
      const priorities = [0, 0, 0, 0, 0];
      recommendations.forEach(rec => {
        if (rec.priority >= 1 && rec.priority <= 5) {
          priorities[rec.priority - 1]++;
        }
      });
      
      priorityChart.data.datasets[0].data = priorities;
      priorityChart.update();
    }

    function viewProduct(productId) {
      if (productId) {
        // Navigate to product details or show modal
        alert(`Product ID: ${productId}\nFeature: View product details`);
      }
    }

    async function refreshAnalytics() {
      // Run new AI analysis
      try {
        const response = await fetch('/api/ai/analyze');
        if (!response.ok) throw new Error('Failed to run analysis');
        
        // Reload analytics
        await loadAnalytics();
        
        // Show success message
        showToast('Analytics refreshed successfully!', 'success');
        
      } catch (error) {
        console.error('Error refreshing analytics:', error);
        showToast('Failed to refresh analytics', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
      
      const toastHTML = `
        <div class="toast align-items-center text-white ${bgClass} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
      }
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toastElement = toastContainer.lastElementChild;
      const toast = new bootstrap.Toast(toastElement);
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
  </script>
</body>
</html>
