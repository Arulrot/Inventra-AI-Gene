{% extends "base.html" %}

{% block title %}Coupon Manager - Inventa AI Gene{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-plus"></i> Add New Coupon</h5>
            </div>
            <div class="card-body">
                <form id="couponForm">
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Coupon Code</label>
                            <input type="text" id="couponCode" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Discount Type</label>
                            <select id="discountType" class="form-select" required>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Discount Value</label>
                            <input type="number" id="discountValue" class="form-control" min="0" step="0.01" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Minimum Amount</label>
                            <input type="number" id="minAmount" class="form-control" min="0" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Max Discount</label>
                            <input type="number" id="maxDiscount" class="form-control" min="0" step="0.01" value="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Usage Limit</label>
                            <input type="number" id="usageLimit" class="form-control" min="1" value="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valid for Days</label>
                        <input type="number" id="validDays" class="form-control" min="1" value="30">
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Add Coupon
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-list"></i> Existing Coupons</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Used/Limit</th>
                                <th>Valid Until</th>
                            </tr>
                        </thead>
                        <tbody id="couponsTableBody">
                            <!-- Coupons will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCoupons();
    
    document.getElementById('couponForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addCoupon();
    });
});

function loadCoupons() {
    fetch('/api/coupons')
        .then(response => response.json())
        .then(coupons => {
            displayCoupons(coupons);
        });
}

function displayCoupons(coupons) {
    const tbody = document.getElementById('couponsTableBody');
    tbody.innerHTML = '';
    
    coupons.forEach(coupon => {
        const row = document.createElement('tr');
        const isExpired = new Date(coupon.valid_until) < new Date();
        const isMaxedOut = coupon.used_count >= coupon.usage_limit;
        
        row.className = (isExpired || isMaxedOut) ? 'table-warning' : '';
        
        row.innerHTML = `
            <td><strong>${coupon.code}</strong></td>
            <td>${coupon.discount_type}</td>
            <td>${coupon.discount_type === 'percentage' ? coupon.discount_value + '%' : 'â‚¹' + coupon.discount_value}</td>
            <td>${coupon.used_count}/${coupon.usage_limit}</td>
            <td>${coupon.valid_until}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function addCoupon() {
    const couponData = {
        code: document.getElementById('couponCode').value,
        discount_type: document.getElementById('discountType').value,
        discount_value: document.getElementById('discountValue').value,
        min_amount: document.getElementById('minAmount').value,
        max_discount: document.getElementById('maxDiscount').value,
        usage_limit: document.getElementById('usageLimit').value,
        valid_days: document.getElementById('validDays').value
    };
    
    fetch('/api/coupons', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(couponData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Coupon added successfully!');
            document.getElementById('couponForm').reset();
            document.getElementById('validDays').value = '30';
            loadCoupons();
        } else {
            alert(data.error);
        }
    });
}
</script>
{% endblock %}
